<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Import and Preprocessing • metabom8</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Data Import and Preprocessing">
<meta property="og:description" content="metabom8">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">metabom8</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MVA.html">Multivariate Analysis and Metabolite ID-ing</a>
    </li>
    <li>
      <a href="../articles/PreProc.html">Data Import and Preprocessing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="PreProc_files/htmlwidgets-1.5.1/htmlwidgets.js"></script><script src="PreProc_files/jquery-1.12.4/jquery.min.js"></script><link href="PreProc_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="PreProc_files/datatables-binding-0.15/datatables.js"></script><link href="PreProc_files/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="PreProc_files/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="PreProc_files/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="PreProc_files/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet">
<script src="PreProc_files/crosstalk-1.1.0.1/js/crosstalk.min.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Data Import and Preprocessing</h1>
                        <h4 class="author">Torben Kimhofer</h4>
            
            <h4 class="date">March 2021</h4>
      
      
      <div class="hidden name"><code>PreProc.Rmd</code></div>

    </div>

    
    
<div id="data-import-quality-control-and-spectral-pre-processing" class="section level1">
<h1 class="hasAnchor">
<a href="#data-import-quality-control-and-spectral-pre-processing" class="anchor"></a>Data import, quality control and spectral pre-processing</h1>
<p> </p>
<p>This tutorial runs through a typical data import and pre-processing workflow for Magnetic Resonance spectroscopy (MRS) - based metabolic profilig with the <em>metabom8</em> R package. Tutorial data are available in the <em>nmrdata</em> R package. Both of these packages are available on the author’s GitHub page and can be installed using the commands below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co"># # obtain NMR training data from GitHub</span>
<span class="co"># install.packages('remotes')</span>
<span class="co"># remotes::install_github('tkimhofer/nmrdata')</span>
<span class="co"># </span>
<span class="co"># # install metaom8 package</span>
<span class="co"># remotes::install_github('tkimhofer/metabom8')</span>

<span class="co"># load packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">nmrdata</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">metabom8</span>)
</pre></div>
<p> </p>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p>Proton (<sup>1</sup>H) NMR data are available in the <em>nmrdata</em> package (www.github.com/tkimhofer) and constitute standard 1D experiments acquired from murine urine samples. Samples were collected longitudinally with a single collection point before and multiple collection points after bariatric surgery was performed. Data acquisition was performed on a 600 MHz Bruker Avance III spectrometer, equipped with a 5 mm triple resonance (TXI) probe operating at 300 K. Further information on study design, experimental setup and data collection can be found in Jia Li <em>et al.</em><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<p> </p>
</div>
<div id="import-of-nmr-spectra-and-metadata" class="section level2">
<h2 class="hasAnchor">
<a href="#import-of-nmr-spectra-and-metadata" class="anchor"></a>Import of NMR spectra and metadata</h2>
<p>The <strong><code><a href="../reference/read1d.html">read1d_proc()</a></code></strong> function imports Bruker NMR spectra into the R workspace. The function requires at minimum two input arguments, that is * <code>path</code>: patht ot the directory that encloses NMR experiments * <code>exp_type</code>: list of spectrometer parameters to select desired experiment types.</p>
<p>In this tutorial all standard 1D experiments are imported, the selection parameter is based on the pulse sequence name: <code>PULPROG='noesypr1d'</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># define path to NMR experiments</span>
<span class="kw">path</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/"</span>, package = <span class="st">"nmrdata"</span>); <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">path</span>)
<span class="co">#&gt; [1] "/Library/Frameworks/R.framework/Versions/4.0/Resources/library/nmrdata/extdata/"</span>

<span class="co"># import 1D MRS data</span>
<span class="fu"><a href="../reference/read1d.html">read1d_proc</a></span>(<span class="kw">path</span>, exp_type=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(PULPROG=<span class="st">'noesypr1d'</span>))
</pre></div>
<p>Three spectral variables are routinely imported into the R workspace upon execution of the <code><a href="../reference/read1d.html">read1d_proc()</a></code> function:</p>
<div id="htmlwidget-78283324d99c59902183" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-78283324d99c59902183">{"x":{"filter":"none","data":[["X","ppm","meta"],["Matrix of NMR data (rows = spectra, columns = spectral variables (ppm))","Array of chemical shift information (ppm)","Dataframe of spectrometer metadata"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Variable Name<\/th>\n      <th>Description<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>The rownames of <em>X</em> indicate the folder location of individual experiments, which can further be used to match sample annotation data (e.g., group-memberships). The dataframe <em><code>meta</code></em> is row-matched to the NMR data matrix (<em><code>X</code></em>) and contains information relating to spectrometer acquisition and TopSpin software processing parameters, including the acquistion date. See <code>?read1d()</code> for more information.</p>
<p> </p>
</div>
<div id="visualisation-of-nmr-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#visualisation-of-nmr-spectra" class="anchor"></a>Visualisation of NMR spectra</h2>
<div id="basic-plotting" class="section level3">
<h3 class="hasAnchor">
<a href="#basic-plotting" class="anchor"></a>Basic plotting</h3>
<p>Plotting functions for visualising of NMR spectra include <strong><code><a href="../reference/spec.html">spec()</a></code></strong> and <strong><code><a href="../reference/matspec.html">matspec()</a></code></strong>. <strong><code><a href="../reference/spec.html">spec()</a></code></strong> can be used to plot a single spectrum. <strong><code><a href="../reference/matspec.html">matspec()</a></code></strong> can be used to overlay of multiple spectra. By default, both fuctions produce interactive line graphs based on <em>plotly</em>. However, due to formatting issues this tutorial will produce static graphics throughout (this is achieved by the function argument to <code>interactive=FALSE</code>). Please feel free to use interactive plot versions (just remove argument <code>interactive=FALSE</code>) as these often provide easier access to the data.</p>
<p>Example script for plotting NMR spectra:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">

<span class="co"># use 'spec' to plot a single pectrum, e.g., in row position 15:</span>
<span class="fu"><a href="../reference/spec.html">spec</a></span>(<span class="kw">X</span>[<span class="fl">15</span>,], <span class="kw">ppm</span>, shift = <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="kw">ppm</span>), interactive=<span class="kw">F</span>)

<span class="co"># use 'matspec' to overlay spectra, in ppm range 0 to 10</span>
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">X</span>, <span class="kw">ppm</span>, shift = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.2</span>, <span class="fl">1.7</span>), interactive=<span class="kw">F</span>)
</pre></div>
<p><img src="PreProc_files/figure-html/spec%20overlay%20I-1.png" width="691.2"><img src="PreProc_files/figure-html/spec%20overlay%20I-2.png" width="691.2"></p>
<p>From this overview we can see that the spectral width ranges from -5 to approximately 15 ppm with the residual water signal resonating around 4.8 ppm. All <sup>1</sup>H NMR signals are situated within the ppm range of 0 and 10, therefore both ends can be capped and this will be illustrated further below.</p>
</div>
<div id="ggplot2" class="section level3">
<h3 class="hasAnchor">
<a href="#ggplot2" class="anchor"></a>ggplot2</h3>
<p>There are different higher-level plotting functions available that allow more comprehensive plot formatting. These functions are based on the <em>ggplot2</em> package. One of these functions is <strong><code><a href="../reference/specOverlay.html">specOverlay()</a></code></strong>, which is comparable to <strong><code><a href="../reference/matspec.html">matspec()</a></code></strong> shown above, but enables to create different subplots (aka facetting) and to include colour scales and linetypes in a straightforward way.</p>
<div id="function-argument-an" class="section level4">
<h4 class="hasAnchor">
<a href="#function-argument-an" class="anchor"></a>Function argument <em>an</em>
</h4>
<p>Plot formatting usiinge colour, text labels and sub-divisions can create insight into the data. In ggplot-based plotting functions of <em>metabom8</em>, these formatting options are passed a list element to the function argument <em>an</em>. The order in which the plotting parameters are provided matters and has the form: <code>an=list([facet], [colour], [lineype])</code>, whereas each list element is a vector with as many elements as there are spectra (=rows) in <em>X</em>.</p>
<p>For illustration purposes, the following code plot the TSP singlet (-0.05 to 0.05 ppm) and annotate spectra with information on spectrometer metadata (found in the <em>meta</em> dataframe). One panel is created for each experiment type, the line colour represents the instrument run order (this is based on the acquisition <em>a_Date</em>) and the linetype indicates the NMR pulse program (<em>a_PULPROG</em>):</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co"># create run-order based on acquistion date</span>
<span class="kw">meta</span><span class="op">$</span><span class="kw">runOrder</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html">rank</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span>(<span class="kw">meta</span><span class="op">$</span><span class="kw">a_DATE</span>))

<span class="co"># plot TSP signal</span>
<span class="fu"><a href="../reference/specOverlay.html">specOverlay</a></span>(<span class="kw">X</span>, <span class="kw">ppm</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.05</span>,<span class="fl">0.05</span>), 
    an=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>( <span class="st">'Facet'</span>=<span class="kw">meta</span><span class="op">$</span><span class="kw">a_EXP</span>, <span class="co"># facet</span>
             <span class="st">'RunOrder'</span>=<span class="kw">meta</span><span class="op">$</span><span class="kw">runOrder</span>, <span class="co"># colour</span>
             <span class="st">'Pulse Program'</span>=<span class="kw">meta</span><span class="op">$</span><span class="kw">a_PULPROG</span>) <span class="co"># linetype</span>
    ) <span class="co"># linetype</span>
</pre></div>
<p><img src="PreProc_files/figure-html/spec%20overlay%20II-1.png" width="672"></p>
<p>The plot above shows that two different experiment types were performed (i.e., two different panels), both based on the pulse program <em>&lt;noesypr1d&gt;</em>, which a Bruker term for a standard 90˚ pulse experiment with water pre-saturation. Experiment types labelled <em>&lt;&gt;</em> are calibration experiements and were performed before <em>&lt;JL-noe1D&gt;</em> were aqcuired (see Date information, i.e., run order).</p>
</div>
</div>
</div>
<div id="chemical-shift-calibration" class="section level2">
<h2 class="hasAnchor">
<a href="#chemical-shift-calibration" class="anchor"></a>Chemical shift calibration</h2>
<p>Chemical shift calibration refers to a horizontal shift of an entire spectrum to place a signal of a standard compound at a defined chemical shift position. In urine metabolic profiling, the standard compound is TSP<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> (usually added to the sample buffer), which gives rise to a singlet that is defined to resonate at 0 ppm.<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a></p>
<p>We can reference the urine spectra using the <strong><code><a href="../reference/calibrate.html">calibrate()</a></code></strong> function, as shown with the following code:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co"># perform TSP calibration</span>
<span class="kw">X_cal</span><span class="op">=</span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span>(<span class="kw">X</span>, <span class="kw">ppm</span>, type=<span class="st">'tsp'</span>)

<span class="co"># plot TSP after calibration</span>
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">X_cal</span>, <span class="kw">ppm</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>), interactive=<span class="kw">F</span>)
</pre></div>
<p><img src="PreProc_files/figure-html/calibration-1.png" width="691.2"></p>
<p>After calibration of the urine spectra, the TSP peak apex is centered at zero ppm.</p>
<p> </p>
</div>
<div id="filtering-based-on-spectrometer-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#filtering-based-on-spectrometer-parameters" class="anchor"></a>Filtering based on spectrometer parameters</h2>
<p>For statistical analysis all caibration experiments are to be excluded and only only standard 1D experiments are kept (<em>&lt;JL-noe1d&gt;</em>). Filtering can be achieved with the folloging code:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="co"># Exclude calibration experiments</span>
<span class="kw">idx</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span>(<span class="st">'noe1d'</span>, <span class="kw">meta</span><span class="op">$</span><span class="kw">a_EXP</span>) 
<span class="kw">X_cal</span><span class="op">=</span><span class="kw">X_cal</span>[<span class="kw">idx</span>,]
<span class="kw">meta</span><span class="op">=</span><span class="kw">meta</span>[<span class="kw">idx</span>,]

<span class="co"># plot TSP signal</span>
<span class="fu"><a href="../reference/specOverlay.html">specOverlay</a></span>(<span class="kw">X_cal</span>, <span class="kw">ppm</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.05</span>,<span class="fl">0.05</span>), 
    an=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>( <span class="st">'Facet'</span>=<span class="kw">meta</span><span class="op">$</span><span class="kw">a_EXP</span>, <span class="co"># facet</span>
             <span class="st">'Receiver Gain'</span>=<span class="kw">meta</span><span class="op">$</span><span class="kw">a_RG</span>, <span class="co"># colour</span>
             <span class="st">'Pulse Program'</span>=<span class="kw">meta</span><span class="op">$</span><span class="kw">a_PULPROG</span>) <span class="co"># linetype</span>
    ) <span class="co"># linetype</span>
</pre></div>
<p><img src="PreProc_files/figure-html/filter-1.png" width="691.2"></p>
<p> </p>
</div>
<div id="assessment-of-spectral-quality" class="section level2">
<h2 class="hasAnchor">
<a href="#assessment-of-spectral-quality" class="anchor"></a>Assessment of spectral quality</h2>
<p>In metabolic phenotyping and in any other field where NMR spectra are compared in a quantitative fashion, the quality of spectra is of particular importance. Spectral quality assessement includes visual inspection of the water suppresion quality, peak symmetry, spectral line widths, baseline level and stability as well as the average signal to noise (SN) ratio.</p>
<p>Visual assessment of spectral quality:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="co"># calculate quality control measures</span>
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">X_cal</span>, <span class="kw">ppm</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4.5</span>,<span class="fl">5</span>), interactive=<span class="kw">F</span>, main=<span class="st">'Residual Water'</span>)
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">X_cal</span>, <span class="kw">ppm</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">9</span>,<span class="fl">11</span>), interactive=<span class="kw">F</span>, main=<span class="st">'LowField Cap'</span>)
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">X_cal</span>, <span class="kw">ppm</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>), interactive=<span class="kw">F</span>, main=<span class="st">'UpField Cap'</span>)


  
</pre></div>
<p><img src="PreProc_files/figure-html/spec%20qc%20I-1.png" width="691.2"><img src="PreProc_files/figure-html/spec%20qc%20I-2.png" width="691.2"><img src="PreProc_files/figure-html/spec%20qc%20I-3.png" width="691.2"></p>
<p> </p>
</div>
<div id="excision-of-signals" class="section level2">
<h2 class="hasAnchor">
<a href="#excision-of-signals" class="anchor"></a>Excision of signals</h2>
<p>Further downstream analysis requires the excision of chemical shift regions bearing no biological or non-quantitative information. In urinary NMR analyses this includes the TSP signal, the residual water and urea signal as well as ppm regions where there is no signal but only noise.</p>
<p>The function <strong><code>get_._idx()</code></strong> can be used to obtain indices of the desired shift range from the ppm vector. These indices can then be further used to exclude the relevant columns in the NMR matrix and ppm vector. This is illustrated in the following code snippet.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="co"># Indexing TSP region and upfield noise...</span>
<span class="kw">idx_tsp</span><span class="op">=</span><span class="fu"><a href="../reference/get.idx.html">get_idx</a></span>(range=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">ppm</span>), <span class="fl">0.5</span>), <span class="kw">ppm</span>)
<span class="co"># ... water region...</span>
<span class="kw">idx_water</span><span class="op">=</span><span class="fu"><a href="../reference/get.idx.html">get_idx</a></span>(range=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4.6</span>, <span class="fl">5</span>), <span class="kw">ppm</span>)
<span class="co"># ... as well as downfield noise regions</span>
<span class="kw">idx_noise</span><span class="op">=</span><span class="fu"><a href="../reference/get.idx.html">get.idx</a></span>(range=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">9.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">ppm</span>)), <span class="kw">ppm</span>)

<span class="kw">idx_rm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">idx_tsp</span>, <span class="kw">idx_water</span>, <span class="kw">idx_noise</span>)

<span class="co"># Exision of TSP, res. water and noise regions</span>
<span class="kw">X_cut</span><span class="op">=</span><span class="kw">X_cal</span>[,<span class="op">-</span><span class="kw">idx_rm</span>]
<span class="kw">ppm</span><span class="op">=</span><span class="kw">ppm</span>[<span class="op">-</span><span class="kw">idx_rm</span>]
</pre></div>
<p> </p>
</div>
<div id="baseline-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#baseline-correction" class="anchor"></a>Baseline correction</h2>
<p>Macromolecules such as proteins produce broad resonances in an NMR spectrum, these are termed spectral baselines. Baseline differences across spectra can produce artifactual statistical effect, and a spectra are typcically baseline corrected to more accurate results. In <em>metabom8</em>, the <strong><code><a href="../reference/bline.html">bline()</a></code></strong> implements a non-linear baseline correction using asymetric least squares. See the exmpale below on how to apply this function.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="co"># Baseline correction</span>
<span class="kw">X_bl</span><span class="op">=</span><span class="fu"><a href="../reference/bline.html">bcor</a></span>(<span class="kw">X_cut</span>)

<span class="co"># visual assessment</span>
<span class="kw">Xcompare</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">X_bl</span>[<span class="fl">1</span>,], <span class="kw">X_cut</span>[<span class="fl">1</span>,])
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">Xcompare</span>, <span class="kw">ppm</span>, shift = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">7</span>, <span class="fl">9</span>), interactive=<span class="kw">F</span>)
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">Xcompare</span>, <span class="kw">ppm</span>, shift = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">4</span>), interactive=<span class="kw">F</span>)
</pre></div>
<p><img src="PreProc_files/figure-html/baseline-1.png" width="691.2"><img src="PreProc_files/figure-html/baseline-2.png" width="691.2"></p>
<p>The black line is the baseline corrected spectrum, the red and dotted line represents the uncorrected spectrum.  </p>
</div>
<div id="spectral-normalisation" class="section level2">
<h2 class="hasAnchor">
<a href="#spectral-normalisation" class="anchor"></a>Spectral normalisation</h2>
<p>Depending on the sample type, spectra may require normalisation prior to statistical analysis. For example, the signal strength in different urine samples can vary substantially, mainly related to the uptake of different amounts of water. Normalisation methods can account for these kind of dilution sensitivy.</p>
<p>There are several normalisation methods avaiable, which method is most suitable depends on the sample type and exerimental setup. Among the most commonly applied ones are Total Area (TA) normalisation and Probablistic Quotient Normalisation (PQN).<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a> In this tutorial, spectra are normalised with the PQN method (<strong><code><a href="../reference/pqn.html">pqn()</a></code></strong>).</p>
<p>The function <strong><code><a href="../reference/pqn.html">pqn()</a></code></strong> requires at least one input, which is the NMR matrix to be normaliseed (<strong>X_bl</strong>), the output of this function will be the PQN normalised data matrix. In the code below, there is on additional input argument provied (<em>add_DilF = ‘dilF.pqn’</em>), which indicates that the calculated dilution factors should be exported to the R workspace as an array named <em>dilF.pqn</em>. Checking the dilution factors can be very informative. For example, if pooled quality control samples were periodically included in the study run, then these should have very comparable dilution factors.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="co"># PQN normalisation</span>
<span class="kw">X_pqn</span><span class="op">=</span><span class="fu"><a href="../reference/pqn.html">pqn</a></span>(<span class="kw">X_bl</span>, add_DilF = <span class="st">'dilf'</span>)

<span class="co"># Visualising the pqn dilution coefficient / scaling factor for each spectrum</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(<span class="kw">dilf</span>, xlab=<span class="st">'PQN calculated dilution factor'</span>)
</pre></div>
<p><img src="PreProc_files/figure-html/normalisation-1.png" width="691.2"></p>
<p>The final step in this preprocessing tutorial is the visual inspection of the pre-processed NMR spectra:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">X_pqn</span>, <span class="kw">ppm</span>, shift = <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="kw">ppm</span>), interactive=<span class="kw">F</span>)
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">X_pqn</span>, <span class="kw">ppm</span>, shift = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.2</span>, <span class="fl">1.7</span>), interactive=<span class="kw">F</span>)
</pre></div>
<p><img src="PreProc_files/figure-html/visal%20check-1.png" width="691.2"><img src="PreProc_files/figure-html/visal%20check-2.png" width="691.2"></p>
<p> </p>
</div>
</div>
<div id="summary-and-further-steps" class="section level1">
<h1 class="hasAnchor">
<a href="#summary-and-further-steps" class="anchor"></a>Summary and further steps</h1>
<p>1D NMR spectra were imported, quality checked and pre-processed which included referencing to TSP, baseline correction, excision of spectral areas that bear no quantitative biological information. Urinary spectra were normalised with PQN to account for different sample dilutions.</p>
<p>The pre-processed spectra can now be statistical interrogated, e.g., using multivariate methods Prinicpal Component Analysis (PCA) and Orthogoanl-Partial-Least Squares (O-PLS). You can find more information on this in the vignette <strong>Multivariate Statistical Analysis</strong>.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Li, Jia V., <em>et al.</em> (2011) Metabolic surgery profoundly influences gut microbial-host metabolic cross-talk. <em>Gut</em> 60.9, 1214-1223.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>3-(trimethylsilyl)-2,2′,3,3′-tetradeuteropropionic acid<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>Dona, A.C., <em>et al.</em> (2014) Precision high-throughput proton NMR spectroscopy of human urine, serum, and plasma for large-scale metabolic phenotyping. <em>Analytical Chemistry</em>. 86.19. 9887-94.<a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p>Dieterly, F.,  (2006), Probabilistic Quotient Normalization as Robust Method to Account for Dilution of Complex Biological Mixtures. Application in 1H NMR Metabonomics, , 78.3, 4281-90<a href="#fnref4" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Torben Kimhofer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
