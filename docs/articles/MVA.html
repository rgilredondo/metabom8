<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multivariate Analysis and Metabolite ID-ing • metabom8</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Multivariate Analysis and Metabolite ID-ing">
<meta property="og:description" content="metabom8">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">metabom8</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MVA.html">Multivariate Analysis and Metabolite ID-ing</a>
    </li>
    <li>
      <a href="../articles/PreProc.html">Data Import and Preprocessing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Multivariate Analysis and Metabolite ID-ing</h1>
                        <h4 class="author">Torben Kimhofer</h4>
            
            <h4 class="date">March 2021</h4>
      
      
      <div class="hidden name"><code>MVA.Rmd</code></div>

    </div>

    
    
<div id="multivariate-statistical-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#multivariate-statistical-analysis" class="anchor"></a>Multivariate statistical analysis</h1>
<p>This tutorial illustrates a multivariate statistical analysis workflow for NMR-based metabolic profilig using the <em>metabom8</em> R package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co"># load packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">nmrdata</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">metabom8</span>)
</pre></div>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p>Proton (<sup>1</sup>H) NMR data are available in the <em>nmrdata</em> package (www.github.com/tkimhofer) and constitute standard 1D experiments acquired from murine urine samples. Samples were collected longitudinally with a single collection point before and multiple collection points after bariatric surgery was performed. Data acquisition was performed on a 600 MHz Bruker Avance III spectrometer, equipped with a 5 mm triple resonance (TXI) probe operating at 300 K. Further information on study design, experimental setup and data collection can be found in Jia Li <em>et al.</em><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># For reproducibility</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">153</span>)
</pre></div>
</div>
<div id="prerequisites" class="section level2">
<h2 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h2>
<p>Data have been preprocessed as illustrated in Tutorial I. In short, spectral reagions that bear no quantitative or biological information were excised and baseline correction was performed proir to spectral normalisation with probabilistic quotient normalisaion (PQN).</p>
<p>Let’s get started with the analysis:</p>
</div>
<div id="data-import" class="section level2">
<h2 class="hasAnchor">
<a href="#data-import" class="anchor"></a>Data import</h2>
<p>Pre-processed data are imported with the <code>data</code> command. The data are saved as a list and the first task is to assign each list element to a variable.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co"># Load data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="kw">bariatric</span>)

<span class="co"># Declare variables</span>
<span class="kw">Xn</span><span class="op">&lt;-</span><span class="kw">bariatric</span><span class="op">$</span><span class="kw">X.pqn</span> <span class="co"># PQN-normalised NMR data matrix</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="kw">Xn</span>)
<span class="co">#&gt; [1]    67 56357</span>

<span class="kw">ppm</span><span class="op">&lt;-</span><span class="kw">bariatric</span><span class="op">$</span><span class="kw">ppm</span>     <span class="co"># chemical shift vector in ppm</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">ppm</span>)
<span class="co">#&gt; [1] 56357</span>

<span class="kw">meta</span><span class="op">&lt;-</span><span class="kw">bariatric</span><span class="op">$</span><span class="kw">meta</span>   <span class="co"># spectrometer metadata</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="kw">meta</span>)
<span class="co">#&gt; [1]  67 417</span>

<span class="kw">an</span><span class="op">&lt;-</span><span class="kw">bariatric</span><span class="op">$</span><span class="kw">an</span>       <span class="co"># sample annotation</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="kw">an</span>)
<span class="co">#&gt; [1] 67  4</span>

<span class="co"># list all environment varaibales</span>
<span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span>()
<span class="co">#&gt; [1] "an"        "bariatric" "meta"      "ppm"       "Xn"</span>
</pre></div>
<p>The following variables should be in the R workspace after executing the code snippet above:</p>
<ul>
<li>
<em>Xn</em> - preprocessed NMR data matrix where rows represent spectra and columns ppm variables</li>
<li>
<em>ppm</em> - chemical shift vector in part per million (ppm), the length of <em>ppm</em> is equal to the number of columns of Xn <em>length(ppm)==ncol(Xn)</em>
</li>
<li>
<em>an</em> - Sample annotation dataframe, containing information about each sample</li>
<li>
<em>meta</em> - Spectrometer metadata, e.g., probe temperature at acquisistion (this data are not essential for this tutorial)</li>
</ul>
</div>
<div id="visual-inspection-of-the-nmr-data" class="section level2">
<h2 class="hasAnchor">
<a href="#visual-inspection-of-the-nmr-data" class="anchor"></a>Visual inspection of the NMR data</h2>
<p>Let’s start with a visual inspection of the pre-processed NMR spectra using the <strong>matspec()</strong> function:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co"># visualise first ten spectra</span>
<span class="fu"><a href="../reference/matspec.html">matspec</a></span>(<span class="kw">Xn</span>[<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,], <span class="kw">ppm</span>, shift = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">10</span>), interactive=<span class="kw">F</span>)
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-3-1.png" width="691.2"></p>
<p>The pre-processed specra range from 0.5 to 9.5 ppm, the water signal has been removed and the baseline is fairly flat.</p>
</div>
<div id="unsupervised-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#unsupervised-analysis" class="anchor"></a>Unsupervised Analysis</h2>
<p>In the first analysis step, data are interrogated using Principal Component Analysis (PCA). PCA is a compression technique that represents the high-dimensional spectrometric data (this relates to the number of spectral variables, here &gt; 56,300) with only a few latent (in the sense of unobserved) components. Each PCA component, referred to as principal component (PC), is a composite of the original variables, formed by weighting and linearly combining the original variables. The weightings (referred to as PCA loadings) are determined to preserve systematic variation trends across samples. Collinear variables, e.g., metabolites that share structural or biological relationships, have similar PC weightings, and different PC’s describe different variation trends.</p>
<p>Typically, PCA allows to become a fairly good overview of variable patterns by looking at the first few PCA components.</p>
<p>In metabom8, a PCA can be calculated with the <strong>pca()</strong> function. Input arguments are the pre-processed NMR matrix (<em>X=Xn</em>), information on the desired number of principal components (<em>pc=2</em>) and variable centering and scaling parameters. Here the data will autoscaled, this includes mean centering (<em>center=TRUE</em>) and unit variance scaling (<em>scale=“UV”</em>).</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co"># Perform PCA</span>
<span class="kw">pca_model</span><span class="op">=</span><span class="fu"><a href="../reference/pca.html">pca</a></span>(X=<span class="kw">Xn</span>, pc=<span class="fl">2</span>, scale=<span class="st">'UV'</span>, center=<span class="fl">TRUE</span>)
</pre></div>
<p>The variable <em>pca.model</em> is an R object that contains different slots containing information about the PCA model - this includes PCA scores (<em>t</em>) and loadings (<em>p</em>) for each of the principal components.</p>
<p>Visualising PCA scores can be achieved with the <strong>plotscores()</strong> and <strong>plotload()</strong> functions. The input of this function is the pca model (<em>model=pca.model</em>), further input parameters include axis definition (which principal components are plotted in x/y space, <em>pc=c(1,2)</em>) and a list object with its first element specifying the point colouring variable (<em>an=list([variable])</em>).</p>
<p>In this example, point colour should indicate the treatment (eg. surgical procedure), which is either none (Pre-op), Roux-en-Y gastric bypass (RYGB, a type of bariatic surgery) or sham surgery<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>. The latter is a control group, included to account for incidential effects induced by the surgical procedure (anesthesia, incision, etc.).</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="co"># Plot PCA results: scores of the first two components</span>
<span class="fu"><a href="../reference/plotscores.html">plotscores</a></span>(obj=<span class="kw">pca_model</span>, pc=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>), an=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(Surgery=<span class="kw">an</span><span class="op">$</span><span class="kw">Class</span>), title=<span class="st">'PCA - Scores plot'</span>)
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<p>The produced scatterplot shows PCA scores of the first two PCs, plotted in x/y space. Each point represents an NMR spectrum (row of the matrix Xn). The percentages in the axis labels describe the amount of variation that is accounted for by the repsective PC, relative to the total amount of variation in the data (this number is also termed R<sup>2</sup>). The dotted ellipse represents the Hotelling’s T<sup>2</sup>, this is a statistical measure to identify outlier samples and can be thought of a multivariate generalisation of a confidence interval.</p>
<p>Additional graphics parameters can be passed to the <strong>plotscores()</strong> function. For example, point shape and text labels are included as list element two and three of <em>an</em>, repsectively. See the following code for an example:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="co"># define scores that should be labelled</span>
<span class="kw">idx</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">pca_model</span><span class="op">@</span>t[,<span class="fl">2</span>]<span class="op">&gt;</span><span class="fl">20</span> <span class="op">&amp;</span> <span class="kw">an</span><span class="op">$</span><span class="kw">Class</span><span class="op">==</span><span class="st">'RYGB'</span>) <span class="co"># PC 2 scores above 20 and in group RYGB</span>

<span class="co"># construct label vector with mouse IDs</span>
<span class="kw">outliers</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">''</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">an</span>))
<span class="kw">outliers</span>[<span class="kw">idx</span>]<span class="op">&lt;-</span><span class="kw">an</span><span class="op">$</span><span class="kw">ID</span>[<span class="kw">idx</span>]

<span class="co"># Plot PCA scores, colour according to class, point shape according to time of sample collection and label outliers</span>
<span class="fu"><a href="../reference/plotscores.html">plotscores</a></span>(obj=<span class="kw">pca_model</span>, pc=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>), an=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  Class=<span class="kw">an</span><span class="op">$</span><span class="kw">Class</span>,         <span class="co"># point colour</span>
  Timepoint=<span class="kw">an</span><span class="op">$</span><span class="kw">Timepoint</span>, <span class="co"># point shape</span>
  ID=<span class="kw">outliers</span>),           <span class="co"># point label</span>
  title=<span class="st">'PCA - Scores plot'</span>)
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
<p>In NMR-based metabonomics, PCA loadings are visualised as a line plot that resembles an NMR spectrum. In metabom8, this is achieved with the <strong>plotload()</strong> function. The funtion’s input arguments are the <em>PCA_metabom8</em> model (<em>mod=pca_model</em>) and the number of the PC to be visualised (eg., <em>pc=1</em>). The code snipped below, the first and second PC loadings are visualised (one at a time), with the latter focussing on the aromatic chemical shift region (6 - 9 ppm).</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="co"># Plot PCA loadings</span>
<span class="fu"><a href="../reference/plotload.html">plotload</a></span>(mod=<span class="kw">pca_model</span>, pc=<span class="fl">1</span>) <span class="co"># 1st principal component </span>
<span class="fu"><a href="../reference/plotload.html">plotload</a></span>(mod=<span class="kw">pca_model</span>, pc=<span class="fl">2</span>) <span class="co"># 2ndt principal component </span>
<span class="fu"><a href="../reference/plotload.html">plotload</a></span>(mod=<span class="kw">pca_model</span>, pc=<span class="fl">2</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">6</span>,<span class="fl">9</span>))  <span class="co"># 2ndt principal component chemical shift reagion 6-9 ppm</span>
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-7-1.png" width="691.2"><img src="MVA_files/figure-html/unnamed-chunk-7-2.png" width="691.2"><img src="MVA_files/figure-html/unnamed-chunk-7-3.png" width="691.2"></p>
<p>In the loadings plot, the x axis describes the chemical shift of each variable, just like in an ordinary NMR spectrum, the y axis is the covariance of the PCA scores and original spectral variables (indicating the peak magnitude and positive or negative model loadings), and the colour represents the PC loading for each variable normalised to range between zero and one. PCA loadings and scores plot are linked such that peaks coloured towards the red colour spectrum are characteristic for spectra with postive (negative) scores when these point up (down) in the loadings plot.</p>
</div>
<div id="unsupervised-vs-supervised-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#unsupervised-vs-supervised-analysis" class="anchor"></a>Unsupervised vs Supervised Analysis</h2>
<p>A scores clustering trend according to surgery type is visible in PCA scores plot. However, PCA is an unsupervised analysis method and is not designed to tease out data patterns related to group effects (eg., sham vs RYGB surgery) or numeric trends related to an outcome variable (eg., recovery time after surgery). Performing PCA with NMR spectra derived from human urine samples typically highlights environmental effects (e.g., diet and drug metabolites) in the first few principal components. In contrast, the murine individuals were housed in a controlled enviroment (with defined diet and day/night cycle), which greately reduces the metabolic variation so that the treatment effects can already be observed in the first two PCA components.</p>
<p>To explicitly model study group effects, sham vs RYGB surgery, we use an extension of a supervised analysis method called Orthogonal-Projections to Latent Structures or also known as <strong>Orthogonal Partial Least Squares (O-PLS)</strong>.<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a></p>
<div id="o-pls" class="section level3">
<h3 class="hasAnchor">
<a href="#o-pls" class="anchor"></a>O-PLS</h3>
<p>O-PLS can be seen as a supervised extension of PCA, where the NMR data matrix (usually termed <em>X</em>) is related to an external variable (usually termed <em>Y</em>) that encodes study outcome information (eg. Sham vs RYGB surgery). O-PLS is separating systematic data variation into Y-predictive and Y-orthogonal, creating a single predictive component and one or more orthogonal components. Consequently, only the predictive component is interpreted in relation to Y. The orthogonal component(s) often encode(s) information related to technical matters (eg., analytical batch effects).</p>
</div>
<div id="model-overfitting-and-underfitting" class="section level3">
<h3 class="hasAnchor">
<a href="#model-overfitting-and-underfitting" class="anchor"></a>Model overfitting and underfitting</h3>
<p>The number of O-PLS orthogonal components must be carefully chosen based on the amount of data variation that is related to the oucome variable Y. If the number of components is too low, the model is underfitted and does not accurately represent the data. In contrast, if too many orthogonal components are fitted, the model describes patterns that are specific to only this one data set (eg. instrumental noise) and these patterns are unrelated to the outcome variable. This is termed data overfitting. O-PLS models that underfit or overfit the data can lead to inaccurate interpretations. So how can one estimate the optimal number of components?</p>
</div>
<div id="q2-and-auroc_cv" class="section level3">
<h3 class="hasAnchor">
<a href="#q2-and-auroc_cv" class="anchor"></a>Q^2 and AUROC_CV</h3>
<p>Statistical resampling techniques are employed to determine the optimal number of orthogonal components in O-PLS context. In essence, a subset of spectra are used to generate an O-PLS model (training set) and the remaining subset is used to validate this model (valiation set). In regression context (continuous Y), validation means comparing predicted Y values for the validation set with the original Y variable values. The index that summarises the accuracy of the prediction is termed Q^2 and ranges from 1 (perfect prediction) to zero or negative values (inaccurate prediction). A high Q^2 value indicates good model fit. In discriminant context (categorical Y), prediction accuracy is assessed using the area under the receiver operator characteristic curve (AUROC_CV). This index ranges from 1 (perfect prediction) to 0 (exact inverted prediction) and values around 0.5 indicate no predictive capacity at all.</p>
<p>In metabom8, the number of components is automatically determined based on the Q^2 and AUROC_CV in regression or discrimnant context, respectively.</p>
</div>
<div id="o-pls-model-training-and-statistical-validation" class="section level3">
<h3 class="hasAnchor">
<a href="#o-pls-model-training-and-statistical-validation" class="anchor"></a>O-PLS model training and statistical validation</h3>
<p>An O-PLS model is calculated with the function <strong>olps()</strong>. The function’s minimum input arguments are the the NMR data matrix (<em>X=Xn</em>) and the outcome variable(s) of interest (<em>Y=[outcome variable]</em>, eg., the surgical procedure). There are a number of other input parameters, such as the statistical validation method to estimate model fit; However, these are not considered at this point and further information can be found in the help section (<em>?opls</em>).</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="co"># Exclude pre-op group</span>
<span class="kw">idx</span><span class="op">=</span><span class="kw">an</span><span class="op">$</span><span class="kw">Class</span>!=<span class="st">'Pre-op'</span>
<span class="kw">X</span><span class="op">=</span><span class="kw">Xn</span>[<span class="kw">idx</span>,]
<span class="kw">Y</span><span class="op">=</span><span class="kw">an</span><span class="op">$</span><span class="kw">Class</span>[<span class="kw">idx</span>]

<span class="co"># Train O-PLS model</span>
<span class="kw">opls.model</span><span class="op">=</span><span class="fu"><a href="../reference/opls.html">opls</a></span>(<span class="kw">X</span>,<span class="kw">Y</span>)
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-8-1.png" width="691.2"></p>
<p>The model summary plot above describes the O-PLS parameters, with each set of bars corresponding to one fitted predictive and the specied number of orthogonal compononents. As you can see, the final model comprises one predictive and one orthogonal components (labelled 1+1). The set of bars on the right-hand side of the plot (slightly transparent) correspond to a model with 1 predictive and 2 orthogonal components (one orthogonal component more than found appropriate). This information is included for comparative purposes and for the evaluation of the automatic stop criteria.</p>
<p>The model summary can also be returned as a table with the following command:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">opls.model</span><span class="op">@</span>summary
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">PC_pred</th>
<th align="right">PC_orth</th>
<th align="right">R2X</th>
<th align="right">AUROC</th>
<th align="right">AUROC_CV</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0.19</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2</td>
<td align="right">NA</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<p>R2X (R2Y) describes the amount of variation that the model describes in the X (Y) variable space. The range of R2X and R2Y is 0-1, with the latter indicating that all variation is explaine by the model.</p>
</div>
<div id="distance-to-the-model-in-x-space" class="section level3">
<h3 class="hasAnchor">
<a href="#distance-to-the-model-in-x-space" class="anchor"></a>Distance to the Model in <em>X</em> Space</h3>
<p>The distance to the model in X space (DModX) is a dianostic measure to spot model outliers. The variable <em>X</em> refers to the independent variables, in this case the NMR matrix. We can access the DModX by calling the <strong>dmodx()</strong> function:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">distX</span><span class="op">=</span><span class="fu"><a href="../reference/dmodx.html">dmodx</a></span>(mod =<span class="kw">opls.model</span>, plot=<span class="kw">T</span>)
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-11-1.png" width="576"></p>
<p>In the plot above each point represents a sample and the dotted horizontal line represents a 95% confidence interval. This threshold is specific for a particular model and varies for different OPLS models. Samples exceeding the confidence line are considered as moderate outliers. In particular if the DModX plot shows any patterns a further investigation should be untertaken. The <em>distX</em> variable in the above code snippet is a dataframe of DModX values which can be used for further instpections.</p>
</div>
</div>
<div id="visualisation-of-o-pls-scores-and-loadings" class="section level2">
<h2 class="hasAnchor">
<a href="#visualisation-of-o-pls-scores-and-loadings" class="anchor"></a>Visualisation of O-PLS Scores and Loadings</h2>
<p>O-PLS model results are visualised in the scores plot, where the x-axis represents the predictive component and the y-axis an orthogonal component. The function <strong>plotscores()</strong> can be used for this taks (see section of PCA scores for function input arguments). An additional input argument is whether cross-validated (CV) scores should be plotted or not. CV scores are derived withing the internal model validation procedure and are considered as statistically robust. See the following code for an example:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="co"># Plot OPLS scores</span>
<span class="fu"><a href="../reference/plotscores.html">plotscores</a></span>(obj=<span class="kw">opls.model</span>, an=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  Surgery=<span class="kw">an</span><span class="op">$</span><span class="kw">Class</span>[<span class="kw">idx</span>],          <span class="co"># colouring according to surgery type</span>
  Timepoint=<span class="kw">an</span><span class="op">$</span><span class="kw">Timepoint</span>[<span class="kw">idx</span>]),   <span class="co"># linetype according to timepoint</span>
  title=<span class="st">'OPLS - Scores plot'</span>,     <span class="co"># plot title</span>
  cv.scores = <span class="kw">T</span>)                  <span class="co"># visualise cross-validated scores</span>
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
<p>The resuling OPLS CV scores plot shows a perfect separation of both surgery types, with all predictive power focussed on the x-axis (that is characteristic for O-PLS, compared to PLS).</p>
<p>The orthogonal component (y-axis) is - in the mathematical sense - unrelated to the outcome variable <em>Y</em>. In some cases, its interpretation can give some insights about the study samples. In the present case, the first orthogonal O-PLS component is associated with effects resulting from spectral normalisation, which was part of the data pre-processing pipeline (not shown here).</p>
<p>The variable influence on the predictive component can be visualised with the <strong>plotload()</strong> function which plots a single O-PLS model line plot (see PCA section).</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu"><a href="../reference/plotload.html">plotload</a></span>(<span class="kw">opls.model</span>, title = <span class="st">'OPLS-DA Loadings'</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>,<span class="fl">9.5</span>))
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-13-1.png" width="691.2"></p>
<p>The function’s input argument <em>type</em> can be used to derive different visualisations of the model loadings, that is either a statistical reconstruction using covariances or <strong>back-scaled loadings</strong>. For details on both of these methods see <em>help(plotload)</em> or the original publication by Cloarec <em>et al.</em>.<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a></p>
<p>The O-PLS loadings plot shown above highlights signals that are systematically different between the RYGB and Sham control group. In many cases, it is helpful to compare the O-PLS model loadings with spectra within certain chemical shift regions. The function <strong>specload()</strong> can be used for this task. From the loadings plot above we can see that the signals within the region of 7.45 - 7.5 ppm has a high model importance, so let’s have a closer look at this:</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu"><a href="../reference/specload.html">specload</a></span>(mod=<span class="kw">opls.model</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">7.3</span>,<span class="fl">7.45</span>), an=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  facet=<span class="kw">an</span><span class="op">$</span><span class="kw">Class</span>[<span class="kw">idx</span>]), 
  type=<span class="st">'backscaled'</span>, 
  alp = <span class="fl">0.5</span>, 
  title = <span class="st">'Overlayed Spectra with Backscaled Loadings'</span>)
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-14-1.png" width="691.2"></p>
<p>The colour gradient-filled line located in the upper plot area shows the OPLS model loadings (in this case: backscaled method). Plotted below are overlayed NMR spectra where the colour represents group membership. It is easy to see that there are group-related intensity differences for two multiplets centered around 7.365 and 7.425 ppm, with on average lower intensities in the Sham group.</p>
</div>
</div>
<div id="metabolite-indentifiation" class="section level1">
<h1 class="hasAnchor">
<a href="#metabolite-indentifiation" class="anchor"></a>Metabolite Indentifiation</h1>
<p>The following section provides the standard pipeline for the identification of metabolites with high OPLS-DA variable importance.</p>
<div id="statistical-total-correlation-spectrsocopy-stocsy" class="section level2">
<h2 class="hasAnchor">
<a href="#statistical-total-correlation-spectrsocopy-stocsy" class="anchor"></a>Statistical total correlation spectrsocopy (STOCSY)</h2>
<p>A single compound/metabolite can have different chemical resonances, ie., it can give rise to multilpe signals in the NMR spectrum. A correlation analysis can help identifying signals from structural relationships. In the field of metabolomics, the spectral correlation analysis is termed Statistical Total Correlaion Spectrsocopy (STOCSY).</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="co"># define driver peak (the ppm variable where all other spectral variables will be correlated to)</span>
<span class="kw">driver1</span><span class="op">=</span><span class="fl">7.834</span>
<span class="co"># perform stocsy</span>
<span class="kw">stocsy_model</span><span class="op">=</span><span class="fu"><a href="../reference/stocsy.html">stocsy</a></span>(<span class="kw">Xn</span>, <span class="kw">ppm</span>, <span class="kw">driver1</span>) 
<span class="co"># zoom-in different plot regions</span>
<span class="fu"><a href="../reference/plotStocsy.html">plotStocsy</a></span>(<span class="kw">stocsy_model</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">7</span>,<span class="fl">8</span>))
<span class="fu"><a href="../reference/plotStocsy.html">plotStocsy</a></span>(<span class="kw">stocsy_model</span>, shift=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3.9</span>, <span class="fl">4</span>))


<span class="co"># observed signals:</span>
<span class="co"># multiplet @ 7.56</span>
<span class="co"># multiplet @ 7.65</span>
<span class="co"># doublet @ 7.84</span>
<span class="co"># doublet @ 3.97 ppm</span>
</pre></div>
<p><img src="MVA_files/figure-html/unnamed-chunk-15-1.png" width="691.2"><img src="MVA_files/figure-html/unnamed-chunk-15-2.png" width="691.2"><img src="MVA_files/figure-html/unnamed-chunk-15-3.png" width="691.2"></p>
<p>Identified signal patterns can be used to search spectroscopic databases that provide NMR reference data. One popular NMR reference database in the field of metabolic profiling is the *Human Metabolome Database (HMDB)**.</p>
<p>Navigate to the database website (www.hmdb.ca) und use the NMR search utility to find the identity of the compound using the chemical shift pattern extracted from the OPLS-DA loadings plot. Use a chemical shift tollerance of 0.01 ppm to account for small calibration differences.</p>
<p>The assignment of putative identities via database search based on the supervised analysis of NMR spectra is oftenonly a first step in identifying spectral signals. Further (2D NMR and spike-in) experiments are often performed to characterise completele unknown compounds.</p>
</div>
</div>
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h1>
<p>This vignette illustrated multivariate statistical analysis of NMR-based metabolic phenotyping data with PCA and O-PLS-DA using the <em>metabom8</em> package. Once a statistically robust OPLS model was established, information on variable importance was extracted using different model visualisations. STOCSY was performed to identify strucutural correlations of metabolites and this information was used to search putative metabolite identities on a spectral database.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Li, Jia V., <em>et al.</em> (2011) Metabolic surgery profoundly influences gut microbial-host metabolic cross-talk. <em>Gut</em> 60.9, 1214-1223.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>In a sham surgery an operation is performed but the surgeon omitts the intended therapeutic procedure.<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>Trygg, J., <em>et al.</em> (2002). Orthogonal projections to latent structures (O-PLS). <em>Journal of Chemometrics</em>, 16.3, 119-28.<a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p>Cloared, O., <em>et al.</em> (2005). Evaluation of the Orthogonal Projection on Latent Structure Model Limitations Caused by Chemical Shift Variability and Improved Visualization of Biomarker Changes in 1H NMR Spectroscopic Metabonomic Studies. <em>Analytical Chemistry</em>. 77.2, 517-26.<a href="#fnref4" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Torben Kimhofer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
